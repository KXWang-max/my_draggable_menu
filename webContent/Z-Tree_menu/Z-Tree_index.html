<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Z-Tree_index</title>
    <script src="/my_draggable_menu/static/js/jquery/jquery-3.4.1/jquery-3.4.1.js"></script>
    <script src="/my_draggable_menu/static/js/zTree/jquery.ztree.all.js"></script>
    <link rel="stylesheet" href="/my_draggable_menu/static/js/zTree/css/metroStyle/metroStyle.css">
    <script>
        var zTree;
        var settings = {
            treeId:"tree_menu",//唯一标识
            async:{
                enable: true,//是否异步
                dataType:'json',
                url:"",//异步加载下一一级加点的URL
                autoParam:["id", "parentid", "name"],//自动传到后端,后端用来查找对应的子节点信息的参数
            },
            view:{
                showTitle:false,
                addHoverDom: addHoverDom,//鼠标hover,显示添加节点
                removeHoverDom: removeHoverDom, //移除
            },
            data: {
                simpleData: {
                    enable: true,  //true 、 false 分别表示 使用 、 不使用 简单数据模式
                    idKey: "id",  //节点数据中保存唯一标识的属性名称
                    pIdKey: "parentid",    //节点数据中保存其父节点唯一标识的属性名称
                    rootPId: 0  //用于修正根节点父节点数据，即 pIdKey 指定的属性值
                },
                key: {
                    name: "name"  //zTree 节点数据保存节点名称的属性名称  默认值："name"
                }
            },
            check:{
                enable:false,  //true 、 false 分别表示 显示 、不显示 复选框或单选框
                nocheckInherit:true  //当父节点设置 nocheck = true 时，设置子节点是否自动继承 nocheck = true
            },
            edit:{
                enable:true,//可编辑状态
                showRemoveBtn:setRemoveBtn,//是否显示删除按钮
                showRenameBtn:setRenameBtn,//是否显示编辑按钮
                drag:{
                    isMove:true,
                    autoOpenTime:200  //拖拽时，父节点自动展开的延时间隔
                }
            },
            callback: {
                beforeDrag:zTreeBeforeDrag,//拖拽前
                beforeDrop: zTreeBeforeDrop,//拖拽操作结束前
                onDrop: zTreeOnDrop,//拖拽操作结束后
            }
        };
        var zNodes =[
            { id:1, parentid:0,  name:"碧辟（中国）投资有限公司", open:true},
                { id:11, parentid:1, name:"1 合资公司"},
                    { id:111, parentid:11, name:"1-1 有限公司"},
                         { id:1111, parentid:111, name:"1 区域"},
                             { id:11111, parentid:1111, name:"1-1 加油站"},
                             { id:11112, parentid:1111, name:"1-2 加油站"},
                         { id:1112, parentid:111, name:"2 区域"},
                         { id:1113, parentid:111, name:"3 区域"},
                    { id:112, parentid:11, name:"1-2 有限公司"},
                    { id:113, parentid:11, name:"1-3 有限公司"},
                { id:12, parentid:1, name:"2 合资公司"},
                    { id:121, parentid:12, name:"2-1 有限公司"},
                    { id:122, parentid:12, name:"2-2 有限公司"},
                    { id:123, parentid:12, name:"2-3 有限公司"},
        ];
        //初始化树
        function initZTree(){
            $.ajax({
                url:"organize!treeLevel.action",//根节点(顶级节点的方法)
                type:"post",
                dataType: "json",
                success: function(data){
                    console.log(data);
                    var zTreeObj = $.fn.zTree.init($("#zTree"),setting, data);
                    //让第一个父节点展开
                    var rootNode_0 = zTreeObj.getNodeByParam('parentid',0,null);
                    zTreeObj.expandNode(rootNode_0, true, false, false, false);
                },
                error: function(){

                }
            });
        };
        //鼠标移入显示添加节点
        var isEdit = true;
        var newCount = 1;
        function addHoverDom(treeId, treeNode) {
            if(isEdit == false){
                return false;
            }
            else{
                var sObj = $("#" + treeNode.tId + "_span"); //获取节点信息
                if (treeNode.editNameFlag || $("#addBtn_"+treeNode.id).length>0) return;
                var addStr = "<span class='button add' id='addBtn_" + treeNode.id + "' title='add node' οnfοcus='this.blur();'></span>"; //定义添加按钮
                sObj.append(addStr);//加载添加按钮
                var btn = $("#addBtn_"+treeNode.id);
                //绑定添加事件，并定义添加操作
                if (btn) btn.bind("click", function(){
                    var zTree = $.fn.zTree.getZTreeObj("treeDemo");
                    //每增加一个子节点，同时将子节点变为可编辑模式，暂定所有新加节点id为9（联调时更改）
                    zTree.addNodes(treeNode, {id:'9', parentid:treeNode.id, name:"new node" + (newCount++)});
                    //node为所有新加节点的对象数组
                    var node = zTree.getNodesByParam("id", '9', null);
                    for(var index in node){
                        zTree.editName(node[index]);
                    }
                    return false;
                    //将新节点添加到数据库中
                    // var name='NewNode';
                    // $.post('./index.php?r=data/addtree&parentid='+treeNode.id+'&name='+name,function (data) {
                    //     var newID = data; //获取新添加的节点Id
                    //     zTree.addNodes(treeNode, {id:newID, parentid:treeNode.id, name:name}); //页面上添加节点
                    //     var node = zTree.getNodeByParam("id", newID, null); //根据新的id找到新添加的节点
                    //     zTree.selectNode(node); //让新添加的节点处于选中状态
                    // });
                });
            }
        };
        //鼠标移除隐藏添加按钮
        function removeHoverDom(treeId, treeNode) {
            $("#addBtn_"+treeNode.id).unbind().remove();
        };
        //根节点不可拖动，'区域'不可拖动
        var regex2=/区域$/;
        function zTreeBeforeDrag(treeId, treeNodes){
            for(var treeNode of treeNodes){
                var str2 = treeNode .name;
                if(treeNode.parentid == 0 || regex2.test(str2) == true){
                    return false;
                    break;
                }
                else
                    return true;
            }
        };
        //拖拽操作结束前
        //'站点'不可移出所属公司，拖拽后改变了被拖拽节点的pid,判断pid及公司名,若不符则在保存时判断错误，并返回保存前的值
        function zTreeBeforeDrop(treeId, treeNodes, targetNode, moveType) {



        };
        //拖拽操作结束后,对应修改被拖动节点的parentid
        function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType) {
            //获取被拖动的节点
            for (var index in treeNodes) {
                console.log(treeNodes[index]);
                treeNodes[index].parentid = targetNode.id;
            }
        };
        //根节点不可删除
         function setRemoveBtn(treeId,treeNode){
             if(treeNode.parentid == 0)
                 return false;
             else
                 return true;
         };
        //公司名及站点名不可更改
        var regex=/公司$/;
        var regex1=/加油站$/;
        function setRenameBtn(treeId,treeNode){
            var str = treeNode.name;
            if(regex.test(str) == true || regex1.test(str) == true)
                return false;
            else
                return true;
        };
        //可编辑状态
        function edit(){
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            isEdit = true;
            zTree.setEditable(true);
            settings.view.addHoverDom = addHoverDom;
        }
        //不可编辑状态
        function save(){
            var zTree = $.fn.zTree.getZTreeObj("treeDemo");
            isEdit = false;
            zTree.setEditable(false);
            settings.view.addHoverDom = null;
        }
        $(function (){
            zTreeObj = $.fn.zTree.init($("#treeDemo"), settings, zNodes); //初始化树
            ///初始化树的方法ajax
            // initZTree();
            zTreeObj.expandAll(true);    //true 节点全部展开、false节点全部收缩
            save();
        });
    </script>
</head>
<body>
<div>
    <div>
        <button onclick="edit();">编辑</button>
        <button onclick="save();">保存</button>
    </div>
    <div>
        <ul id="treeDemo" class="ztree"></ul>
    </div>
</div>
</body>
</html>